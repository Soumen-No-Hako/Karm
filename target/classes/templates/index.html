<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: mainLayout(~{::pageContent})}">

<head>
    <title>Dashboard</title>
</head>

<body>
    <div th:fragment="pageContent">
        <div class="container-fluid p-4">
            <!-- Search Bar -->
            <div class="row mb-4">
                <div class="col-md-8 mx-auto">
                    <form action="/" method="get" class="d-flex gap-2">
                        <input type="text" name="query" class="form-control form-control-lg shadow-sm"
                            placeholder="Search projects or work items..." required>
                        <select name="filterType" class="form-select form-select-lg shadow-sm"
                            style="max-width: 200px;">
                            <option value="ALL">All</option>
                            <option value="PROJECT">Projects</option>
                            <option value="WORKITEM">Work Items</option>
                        </select>
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Search Header -->
            <div th:if="${isSearch}" class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h3 class="fw-bold text-secondary">Search Results</h3>
                    <p class="text-muted">
                        Showing results for "<span class="fw-bold text-dark" th:text="${query}">query</span>"
                        <span th:if="${filterType != 'ALL'}" th:text="'(Filter: ' + ${filterType} + ')'"></span>
                    </p>
                </div>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>

            <!-- Dashboard Header -->
            <div th:unless="${isSearch}" class="d-flex justify-content-between align-items-center mb-5">
                <h3 class="fw-bold text-secondary">My Projects</h3>
                <a href="/project/new" class="btn btn-dark btn-lg shadow-sm">
                    <i class="fas fa-plus-circle me-2"></i>Create New Project
                </a>
            </div>

            <div th:if="${EmptyProject}" class="text-center py-5 bg-white rounded-4 shadow-sm">
                <h4 class="text-muted">No projects found. Create one to get started!</h4>
            </div>

            <h4 th:if="${isSearch} and !${projects.empty}" class="fw-bold text-primary mb-3"><i
                    class="fas fa-folder me-2"></i>Matching Projects</h4>

            <div th:unless="${EmptyProject}" class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col" th:each="p : ${projects}">

                    <div class="card h-100 shadow-sm border border-success border-2 hover-card" style="cursor: pointer;"
                        th:onclick="loadAndOpenPanel([[${p.projectId}]], [[${p.projectName}]])">

                        <div class="card-header bg-white border-0 pt-3 pb-0" th:text="${p.projectId}">
                        </div>

                        <div class="card-body pt-2">
                            <h4 class="card-title text-primary fw-bold" th:text="${p.projectName}">Name</h4>
                            <p class="card-text text-secondary" th:text="${p.projectDescription}">Desc</p>
                            Current State: <p class="card-text text-secondary" th:text="${p.projectStatus}">Status</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">
                                <i class="fas fa-layer-group me-1"></i>
                                <span th:text="${p.workitemContainerSize}">0</span> Work Items
                            </span>
                            <div class="ms-3" style="z-index: 10;" onclick="event.stopPropagation()">
                                <form action="/project/status" method="post">
                                    <input type="hidden" name="projectId" th:value="${p.projectId}">

                                    <select name="projectStatus" class="form-select form-select-sm fw-bold"
                                        onchange="this.form.submit()"
                                        th:classappend="${p.projectStatus == 'DONE' ? 'text-success border-success' :
                                                 (p.projectStatus == 'IN-PROGRESS' ? 'text-info border-info' : 'text-warning border-warning')}">
                                        <option value="TO-DO" th:selected="${p.projectStatus == 'TO-DO'}">To Do</option>
                                        <option value="IN-PROGRESS" th:selected="${p.projectStatus == 'IN-PROGRESS'}">In
                                            Progress</option>
                                        <option value="DONE" th:selected="${p.projectStatus == 'DONE'}">Done</option>
                                        <option value="CANCELED" th:selected="${p.projectStatus == 'CANCELED'}">
                                            Cancelled</option>
                                    </select>
                                </form>
                            </div>
                            <a th:href="@{/workitem/new/{id}(id=${p.projectId})}"
                                class="btn btn-outline-primary btn-sm position-relative" style="z-index: 10;"
                                onclick="event.stopPropagation()">
                                <i class="fas fa-plus me-1"></i> Create Workitem
                            </a>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Work Items Section (Search Only) -->
            <div th:if="${isSearch} and !${workItems.empty}" class="mt-5">
                <h4 class="fw-bold text-info mb-3"><i class="fas fa-tasks me-2"></i>Matching Work Items</h4>
                <div class="list-group shadow-sm">
                    <a th:each="w : ${workItems}" th:href="@{/workitem/{id}(id=${w.workItemId})}"
                        class="list-group-item list-group-item-action p-3">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1 fw-bold text-dark" th:text="${w.workItemTitle}">Title</h5>
                            <small class="text-muted" th:text="${w.workItemId}">ID</small>
                        </div>
                        <p class="mb-1 text-secondary" th:text="${w.workItemDescription}">Description</p>
                        <small class="badge bg-light text-dark border" th:text="${w.status}">Status</small>
                    </a>
                </div>
            </div>

            <!-- No Results (Search Only) -->
            <div th:if="${isSearch} and ${projects.empty} and ${workItems.empty}"
                class="text-center py-5 bg-white rounded-4 shadow-sm">
                <h4 class="text-muted">No results found matching your criteria.</h4>
                <p class="text-secondary">Try adjusting your search terms or filter.</p>
            </div>

            <div class="offcanvas offcanvas-end w-50" tabindex="-1" id="projectPanel">
                <div class="offcanvas-header bg-primary text-white">
                    <h5 class="offcanvas-title" id="panelTitle">Loading...</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
                </div>

                <div class="offcanvas-body bg-light p-0">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-white">
                        <h6 class="text-muted text-uppercase mb-0">Work Items</h6>
                        <a id="panelEditLink" href="#" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit me-1"></i> Edit Project
                        </a>
                    </div>

                    <div id="panelContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <script th:inline="javascript">
            function loadAndOpenPanel(projectId, projectName) {
                // 1. Get Elements
                const panelEl = document.getElementById('projectPanel');
                const titleEl = document.getElementById('panelTitle');
                const contentEl = document.getElementById('panelContent');
                const editLink = document.getElementById('panelEditLink');

                // 2. Set Static Data (Title and Edit Link)
                titleEl.textContent = projectName;
                editLink.href = '/project/edit/' + projectId;

                // 3. Show Loading Spinner
                contentEl.innerHTML = `
                <div class="text-center py-5 mt-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading tasks...</p>
                </div>
            `;

                // 4. Show the Panel (Bootstrap 5 API)
                const bsOffcanvas = new bootstrap.Offcanvas(panelEl);
                bsOffcanvas.show();

                // 5. Fetch Data from Controller
                fetch('/workitems/' + projectId)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok");
                        return response.text(); // Get HTML text
                    })
                    .then(html => {
                        // 6. Inject HTML into the content div
                        contentEl.innerHTML = html;
                    })
                    .catch(error => {
                        contentEl.innerHTML = `<div class="alert alert-danger m-3">Error loading items.</div>`;
                        console.error('Error:', error);
                    });
            }
        </script>
    </div>
</body>

</html>